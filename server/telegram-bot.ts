import TelegramBot from 'node-telegram-bot-api';

// Initialize Telegram Bot
const botToken = process.env.TELEGRAM_BOT_TOKEN;
const channelId = process.env.TELEGRAM_CHANNEL_ID;

let bot: TelegramBot | null = null;

if (botToken && channelId) {
  bot = new TelegramBot(botToken, { polling: false });
  console.log('âœ… Telegram bot initialized successfully');
} else {
  console.warn('âš ï¸ Telegram bot credentials not found. Telegram notifications will be disabled.');
}

interface InvestmentUpdate {
  investmentId: number;
  userId: number;
  userFirstName?: string;
  userLastName?: string;
  planName: string;
  profit: string;
  totalProfit: string;
  marketSource: string;
  transactionHash: string;
  timestamp: string;
}

interface NewInvestment {
  investmentId: number;
  userId: number;
  userFirstName?: string;
  userLastName?: string;
  planName: string;
  amount: string;
  duration: number;
  expectedROI: number;
  timestamp: string;
}

export async function sendInvestmentUpdateToChannel(update: InvestmentUpdate): Promise<void> {
  if (!bot || !channelId) {
    console.log('Telegram bot not configured, skipping channel update');
    return;
  }

  try {
    const userDisplay = update.userFirstName 
      ? `${update.userFirstName}${update.userLastName ? ' ' + update.userLastName : ''}` 
      : `User ${update.userId}`;

    const message = `ğŸš€ *BITVAULT PRO LIVE UPDATE*

ğŸ’° *Investment Profit Generated*
ğŸ‘¤ Investor: ${userDisplay}
ğŸ“Š Plan: *${update.planName}*
ğŸ’ Investment ID: \`#${update.investmentId}\`

âœ… *Latest Profit:* +${update.profit} BTC
ğŸ“ˆ *Total Accumulated:* ${update.totalProfit} BTC
ğŸ”„ *Generated by:* ${update.marketSource}

ğŸ” Transaction: \`${update.transactionHash.substring(0, 16)}...\`
â° ${new Date(update.timestamp).toLocaleString('en-US', { 
  timeZone: 'UTC',
  dateStyle: 'medium',
  timeStyle: 'short'
})} UTC

*Automated returns delivered every 10 minutes* âš¡

\`#BitVaultPro #Bitcoin #Investment #Profit\``;

    await bot.sendMessage(channelId, message, { 
      parse_mode: 'Markdown',
      disable_web_page_preview: true 
    });
    
    console.log(`ğŸ“± Telegram update sent for investment #${update.investmentId}`);
  } catch (error) {
    console.error('âŒ Failed to send Telegram update:', error);
  }
}

export async function sendNewInvestmentToChannel(investment: NewInvestment): Promise<void> {
  if (!bot || !channelId) {
    console.log('Telegram bot not configured, skipping channel update');
    return;
  }

  try {
    const userDisplay = investment.userFirstName 
      ? `${investment.userFirstName}${investment.userLastName ? ' ' + investment.userLastName : ''}` 
      : `User ${investment.userId}`;

    const message = `ğŸŒŸ *NEW INVESTMENT ACTIVATED*

ğŸ‘¤ *Investor:* ${userDisplay}
ğŸ“ˆ *Plan:* ${investment.planName}
ğŸ’° *Amount:* ${investment.amount} BTC
â±ï¸ *Duration:* ${investment.duration} days
ğŸ¯ *Expected ROI:* ${investment.expectedROI}%

ğŸ’ *Investment ID:* \`#${investment.investmentId}\`

ğŸš€ *Automated profit generation starts now!*
Returns will be delivered every 10 minutes âš¡

â° ${new Date(investment.timestamp).toLocaleString('en-US', { 
  timeZone: 'UTC',
  dateStyle: 'medium',
  timeStyle: 'short'
})} UTC

*Welcome to BitVault Pro professional investment platform* ğŸ‰

\`#BitVaultPro #NewInvestment #Bitcoin #Trading\``;

    await bot.sendMessage(channelId, message, { 
      parse_mode: 'Markdown',
      disable_web_page_preview: true 
    });
    
    console.log(`ğŸ“± New investment notification sent for #${investment.investmentId}`);
  } catch (error) {
    console.error('âŒ Failed to send new investment notification:', error);
  }
}

export async function sendDailyStatsToChannel(): Promise<void> {
  if (!bot || !channelId) {
    console.log('Telegram bot not configured, skipping daily stats');
    return;
  }

  try {
    const message = `ğŸ“Š *BITVAULT PRO DAILY REPORT*

ğŸ”¥ *Platform Statistics*
âš¡ Automated returns: *Active*
ğŸ¯ Investment plans: *3 Available*
ğŸ’ Returns frequency: *Every 10 minutes*
ğŸš€ Success rate: *99.9%*

ğŸ“ˆ *Available Plans:*
â€¢ *Starter:* 0.2% daily (30 days)
â€¢ *Growth:* 0.5% daily (60 days)  
â€¢ *Premium:* 0.8% daily (90 days)

ğŸ’° *Join thousands of successful investors*
ğŸ” *Bank-grade security guaranteed*

â° ${new Date().toLocaleString('en-US', { 
  timeZone: 'UTC',
  dateStyle: 'full',
  timeStyle: 'short'
})} UTC

\`#BitVaultPro #DailyReport #Bitcoin #Investing\``;

    await bot.sendMessage(channelId, message, { 
      parse_mode: 'Markdown',
      disable_web_page_preview: true 
    });
    
    console.log('ğŸ“± Daily stats sent to Telegram channel');
  } catch (error) {
    console.error('âŒ Failed to send daily stats:', error);
  }
}

export { bot };